<?php

/**
 * @file
 * Tide Station Locator module functionality.
 */

use Drupal\migrate_tools\MigrateExecutable;
use Drupal\migrate\MigrateMessage;

/**
 * This function is for accessing the API.
 */
function tide_station_locator_get_api_data($delta = FALSE) {
  $station_api_connector = \Drupal::service('tide_station_locator.station_api_connector');

  // Connect API.
  $result = $station_api_connector->connectApi();

  // Get API response.
  $full_data = $station_api_connector->getApiResponse($result['clientId'], $result['accessToken'], $result['rdm_auth'], $delta);

  if ($full_data && !empty($full_data['records'])) {
    // Get formatted data and save the file.
    $station_api_connector->getFormattedStationResponse($full_data['records']);
  }
}

/**
 * Function to migrate stations.
 */
function tide_station_locator_migrate_stations($options) {

  try {
    // Connect to API and download the latest station JSON and migrate.
    tide_station_locator_get_api_data($options['delta']);
    if ($options['execute-dependencies'] == TRUE) {
      $dependent_migrations =
        [
          'station_accessibility_terms',
          'station_speciality_services_facility_terms',
          'station_state_terms',
        ];
      foreach ($dependent_migrations as $migration_ids) {
        _tide_station_locator_migrate($migration_ids);
      }
    }
    _tide_station_locator_migrate('station_nodes');
  }
  catch (Exception $e) {
    // Something went wrong somewhere.
    watchdog_exception('tide_station_locator', $e);
  }
}

/**
 * Helper function to run the migration.
 */
function _tide_station_locator_migrate($migration_id) {
  $migration = \Drupal::service('plugin.manager.migration')
    ->createInstance($migration_id);
  $migration->getIdMap()->prepareUpdate();
  $executable = new MigrateExecutable($migration, new MigrateMessage());
  $executable->import();
}
